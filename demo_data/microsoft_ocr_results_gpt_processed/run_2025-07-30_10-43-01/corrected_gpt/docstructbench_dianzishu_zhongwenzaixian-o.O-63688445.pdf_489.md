使用也可一起使用。IKE则提供加密算法、密钥等的协商。


# 1. 安全关联和安全策略

安全关联(Security Association,SA)是指提供通信安全服务的发送方和接收方之间
的一种单向关系。安全关联是构成IPSec的基础,它是进行通信的双方经协商建立起来的
一种协定。安全关联可以用一个32位的安全参数索引(Security Parameter Index, SPI)来
唯一标识,一个SPI值决定一个特定的SA,它通常放在AH或ESP头中;安全关联是单
向的,如果要对两台主机A与B实现双向安全,则需要两个安全关联,每个方向一个:(A,
B)、(B,A)。安全关联的内容包含了IP数据包是否加密、认证,以及加密、认证采用的
算法、密钥等相关信息。所有的SA记录都存放在安全关联数据库中,按散列方式存取。

安全策略(Security Policy)定义了两个IPSec系统之间的安全通信特征,并决定在该
通信中为数据包提供的安全服务。一个IPSec系统的所有安全策略都存放在安全策略数据
库中,根据选择符(包括源地址、目的地址、协议、端口等)进行检索。安全策略通常与
SA合作,共同作用于通信的数据包。


# 2. AH

AH协议先将数据进行校验和加密,然后封装为IP包,从而实现无连接通信的数据完
整性、数据源认证和防止重放攻击。AH能完成除数据加密外的所有的ESP所能提供的功
能。在认证机制上,它所覆盖的范围比ESP的广,包括对IP头中一些选项的认证。

为了应用IPSec协议,IP数据包的格式要有所改变,即在IP头和被保护的数据之间插
入一个AH头,如图 16-3 所示。


图16-3 用AH保护的IP数据包格式示意图

![IP头 AH头 被保护的数据](figures/1.1)


AH头的格式如图16-4所示,包括:下一报头、有效载荷长度、保留位、安全参数索
引、序列号、认证数据。


图 16-4 AH 头的格式

| 下一个报头 | 有效载荷长度 | 保留位 |
| - | - | - |
| 安全参数索引(SPI) | | |
| 序列号 | | |
| 认证数据(AD) | | |


AH使用的典型的认证算法是一种迭代型的消息摘要算法。AH中采用MD5算法,可
以提供完整性服务。从前面的讲述可以知道MD5可以对任意长度的信息进行散列运算产
生一个唯一的128位消息摘要。由于消息摘要是唯一的,所以对信息的任何修改都将得到另
一个不同的消息摘要,因此能防止消息被篡改,从而保证了数据的完整性。AH也可以采用
SHA算法提供更强的抗攻击能力,SHA是在MD5的基础上,增加了分组处理的迭代次数

<!-- PageNumber="472" -->
```